00000000                                     1  
00000000                                     2  ************************************************************
00000000                                     3  **********AREA DATI**************************************
00000000  =00002004                          4  PIABD_C		EQU    		$2004		;indirizzo di PIA-B dato per il nodo b
00000000  =00002005                          5  PIABC_C		EQU    		$2005		;indirizzo di PIA-B stato/controllo per il nodo b
00000000  =00002008                          6  PIABD_B		EQU    		$2008		;indirizzo di PIA-B dato per il nodo c
00000000  =00002009                          7  PIABC_B		EQU    		$2009		;indirizzo di PIA-B stato/controllo per il nodo c
00000000  =00000005                          8  N_CAR			EQU		5
00000000                                     9  
00008000                                    10  			ORG		$8000
00008000  05                                11  N			DC.B		5	; numero di caratteri dei messaggi
00008001  02                                12  M_B			DC.B		2	; numero di messaggi di b
00008002  04                                13  K			DC.B		4	; numero di iterazioni
00008003                                    14  
00008003  00                                15  CONT_K		DC.B		0	; contatore delle iterazioni
00008004                                    16  
00008004                                    17  MSG_B		DS.B		N_CAR	; messaggio di b (di volta in volta verrà sovrascritto)
00008009                                    18  MSG_C		DS.B		N_CAR	; messaggio di c (di volta in volta verrà sovrascritto)
0000800E                                    19  
0000800E  00                                20  CONT_C_B		DC.B		0	; contatore caratteri ricevuti da b
0000800F  00                                21  CONT_C_C		DC.B		0	; contatore caratteri ricevuti da c
00008010                                    22  
00008010  00                                23  CONT_M_B		DC.B		0	; contatore messaggi ricevuti da b
00008011                                    24  
00008011  00                                25  FLG_B			DC.B		0	; flag che indica se ho ricevuto 2 messaggi interi da b
00008012  00                                26  FLG_C			DC.B		0	; flag che indica se ho ricevuto un intero messaggio da c
00008013                                    27  
00008013  00                                28  LOCK			DC.B		0	; variabile per l'uso del TAS
00008014  00                                29  POS			DC.B		0	; POS = 0 indica nessun possesso, POS = 1 indica possesso di b, POS = 2 indica possesso di c
00008015                                    30  
00008015  00                                31  SOS_B			DC.B		0	; SOS_B = 1 indica che b è sospeso
00008016  00                                32  SOS_C			DC.B		0	; SOS_C = 1 indica che c è sospeso
00008017                                    33  ***********************************************************
00008017                                    34  ***********AREA MAIN*********************************	
00008300                                    35  			ORG    		$8300
00008300                                    36  MAIN			
00008300  4EB9 00008316                     37  			JSR		INITB_PIAB	;inizializza PIA porto B di b
00008306  4EB9 0000832E                     38  			JSR		INITC_PIAB	;inizializza PIA porto B di c
0000830C                                    39  
0000830C                                    40  
0000830C                                    41  			*MOVE.W	SR,D0			;legge il registro di stato
0000830C  027C 00FF                         42  			ANDI	#$00FF,SR 		;maschera per reg stato (stato utente, int abilitati)
00008310                                    43  			*MOVE.W	D0,SR			;pone liv int a 000
00008310                                    44  
00008310  4EF9 00008310                     45  LOOP  			JMP 		LOOP				
00008316                                    46  	
00008316                                    47  
00008316                                    48  *********************************************************************************************************
00008316                                    49  *********************************************************************************************************
00008316                                    50  INITB_PIAB
00008316  11FC 0000 2009                    51  			MOVE.B	#$00,PIABC_B				
0000831C  11FC 0000 2008                    52  			MOVE.B	#$00,PIABD_B		    
00008322  11FC 00E5 2009                    53  			MOVE.B	#%11100101,PIABC_B 
00008328  1038 2008                         54  			MOVE.B  	PIABD_B,D0
0000832C                                    55  			
0000832C                                    56  			
0000832C  4E75                              57  			RTS
0000832E                                    58  
0000832E                                    59  *********************************************************************************************************
0000832E                                    60  *********************************************************************************************************
0000832E                                    61  INITC_PIAB
0000832E  11FC 0000 2005                    62  			MOVE.B	#$00,PIABC_C				
00008334  11FC 0000 2004                    63  			MOVE.B	#$00,PIABD_C		    
0000833A  11FC 00E5 2005                    64  			MOVE.B	#%11100101,PIABC_C 
00008340  1038 2004                         65  			MOVE.B  	PIABD_C,D0
00008344                                    66  			
00008344                                    67  			
00008344  4E75                              68  			RTS
00008346                                    69  
00008346                                    70  
00008346                                    71  *******************************************************************************************************
00008346                                    72  *La pia-B ha ricevuto un carattere dalla pia-A partner, interrompe il processore che
00008346                                    73  *con la ISR riceve il carattere e lo salva in memoria
00008346                                    74  *ISR a $8700 associata all' interrupt di liv. 3  #vect 27  mappato a $6C della ROM
00008346                                    75  ********************************************************************************************************	
00008346                                    76  	
00008700                                    77  			ORG 		$8700		
00008700                                    78  
00008700                                    79  IRQ_B    
00008700  48E7 C0C0                         80  			MOVEM.L	D0-D1/A0-A1,-(A7)
00008704                                    81  
00008704  4AF9 00008013                     82  IF_B_1			TAS 		LOCK
0000870A  6600 00DA                         83  			BNE		ELSE_B_1
0000870E                                    84  
0000870E  1039 00008014                     85  			MOVE.B	POS,D0
00008714  B03C 0001                         86  IF_B_2			CMP.B		#1,D0
00008718  6700 0018                         87  			BEQ		SKIPB
0000871C                                    88  
0000871C                                    89  		
0000871C                                    90  			
0000871C  B03C 0000                         91  			CMP.B		#0,D0
00008720  6600 00BC                         92  			BNE		ELSE_B_2
00008724                                    93  
00008724  1039 00008011                     94  			MOVE.B	FLG_B,D0
0000872A  B03C 0000                         95  			CMP.B		#0,D0
0000872E  6600 00AE                         96  			BNE		ELSE_B_2
00008732                                    97  		
00008732                                    98  
00008732  13FC 0001 00008014                99  SKIPB			MOVE.B	#1,POS
0000873A  13FC 0000 00008013               100  			MOVE.B	#0,LOCK
00008742                                   101  
00008742  207C 00002008                    102  RX_B			MOVEA.L	#PIABD_B,A0
00008748  227C 00008004                    103  			MOVEA.L	#MSG_B,A1
0000874E  1039 0000800E                    104  			MOVE.B	CONT_C_B,D0
00008754                                   105  
00008754  1390 0000                        106  			MOVE.B	(A0),(A1,D0)
00008758  5200                             107  			ADD.B		#1,D0
0000875A  13C0 0000800E                    108  			MOVE.B	D0,CONT_C_B
00008760                                   109  			
00008760  1239 00008000                    110  			MOVE.B	N,D1
00008766  B240                             111  IF_B_3			CMP		D0,D1
00008768  6600 00E0                        112  			BNE		FINE_B
0000876C                                   113  
0000876C  13FC 0000 0000800E               114  			MOVE.B	#0,CONT_C_B
00008774  1039 00008010                    115  			MOVE.B	CONT_M_B,D0
0000877A  5200                             116  			ADD.B		#1,D0
0000877C  13C0 00008010                    117  			MOVE.B	D0,CONT_M_B
00008782                                   118  
00008782  1239 00008001                    119  			MOVE.B	M_B,D1
00008788  B240                             120  IF_B_4			CMP		D0,D1
0000878A  6600 0066                        121  			BNE		ELSE_B_4
0000878E                                   122  
0000878E  13FC 0000 00008010               123  			MOVE.B	#0,CONT_M_B
00008796  13FC 0001 00008011               124  			MOVE.B	#1,FLG_B
0000879E  13FC 0000 00008014               125  			MOVE.B	#0,POS
000087A6                                   126  
000087A6  1039 00008012                    127  			MOVE.B	FLG_C,D0
000087AC  B03C 0001                        128  IF_B_5			CMP.B		#1,D0
000087B0  6600 005C                        129  			BNE		RISVEGLIO_C
000087B4                                   130  
000087B4  1039 00008003                    131  			MOVE.B	CONT_K,D0
000087BA  5200                             132  			ADD.B		#1,D0
000087BC  13C0 00008003                    133  			MOVE.B	D0,CONT_K
000087C2                                   134  
000087C2  1239 00008002                    135  			MOVE.B	K,D1
000087C8  B200                             136  IF_B_6			CMP.B		D0,D1
000087CA  6600 0032                        137  			BNE		ELSE_B_6
000087CE                                   138  
000087CE  11FC 0000 2009                   139  			MOVE.B	#0,PIABC_B
000087D4  11FC 0000 2005                   140  			MOVE.B	#0,PIABC_C
000087DA                                   141  
000087DA  6000 006E                        142  			BRA		FINE_B
000087DE                                   143  
000087DE  13FC 0000 00008013               144  ELSE_B_2		MOVE.B	#0,LOCK
000087E6  13FC 0001 00008015               145  ELSE_B_1		MOVE.B	#1,SOS_B
000087EE  6000 005A                        146  			BRA		FINE_B
000087F2                                   147  
000087F2  13FC 0000 00008014               148  ELSE_B_4		MOVE.B	#0,POS
000087FA  6000 0012                        149  			BRA		RISVEGLIO_C
000087FE                                   150  
000087FE  13FC 0000 00008011               151  ELSE_B_6		MOVE.B	#0,FLG_B
00008806  13FC 0000 00008012               152  			MOVE.B	#0,FLG_C
0000880E                                   153  			
0000880E  1039 00008016                    154  RISVEGLIO_C		MOVE.B	SOS_C,D0
00008814  B03C 0001                        155  IF_B_7			CMP.B		#1,D0
00008818  6600 0030                        156  			BNE		FINE_B
0000881C                                   157  
0000881C  13FC 0002 00008014               158  			MOVE.B	#2,POS
00008824  13FC 0000 00008016               159  			MOVE.B	#0,SOS_C
0000882C                                   160  			
0000882C  1039 0000800F                    161  			MOVE.B	CONT_C_C,D0
00008832  207C 00002004                    162  			MOVEA.L 	#PIABD_C,A0
00008838  227C 00008009                    163  			MOVEA.L	#MSG_C,A1
0000883E                                   164  
0000883E  1390 0000                        165  			MOVE.B	(A0),(A1,D0)
00008842  5200                             166  			ADD.B		#1,D0
00008844  13C0 0000800F                    167  			MOVE.B	D0,CONT_C_C
0000884A                                   168  	
0000884A  4CDF 0303                        169  FINE_B		MOVEM.L	(A7)+,A1-A0/D1-D0
0000884E  4E73                             170  			RTE
00008850                                   171  
00008850                                   172  *******************************************************************************************************
00008850                                   173  *La pia-B ha ricevuto un carattere dalla pia-A partner, interrompe il processore che
00008850                                   174  *con la ISR riceve il carattere e lo salva in memoria
00008850                                   175  *ISR a $8800 associata all' interrupt di liv. 4 mappato a $70 della ROM
00008850                                   176  ********************************************************************************************************
00008900                                   177  			ORG 		$8900		
00008900                                   178  
00008900                                   179  IRQ_C			
00008900  48E7 E0C0                        180  			MOVEM.L	D0-D2/A0-A1,-(A7)
00008904                                   181  
00008904  4AF9 00008013                    182  IF_C_1			TAS		LOCK
0000890A  6600 00A8                        183  			BNE		ELSE_C_2
0000890E                                   184  
0000890E  1039 00008012                    185  			MOVE.B	FLG_C,D0
00008914  B03C 0000                        186  			CMP.B		#0,D0
00008918  6600 009A                        187  			BNE		ELSE_C_2
0000891C                                   188  
0000891C  1039 00008014                    189  			MOVE.B	POS,D0
00008922  B03C 0002                        190  			CMP.B		#2,D0
00008926  6700 0012                        191  			BEQ		SKIPC
0000892A                                   192  
0000892A  B03C 0000                        193  IF_C_2			CMP.B		#0,D0
0000892E  6600 0084                        194  			BNE		ELSE_C_2
00008932                                   195  
00008932  13FC 0002 00008014               196  			MOVE.B	#2,POS
0000893A  13FC 0000 00008013               197  SKIPC			MOVE.B	#0,LOCK
00008942                                   198  
00008942  207C 00002004                    199  RX_C			MOVEA.L	#PIABD_C,A0
00008948  227C 00008009                    200  			MOVEA.L	#MSG_C,A1
0000894E  1039 0000800F                    201  			MOVE.B	CONT_C_C,D0
00008954                                   202  			
00008954  1390 0000                        203  			MOVE.B	(A0),(A1,D0)
00008958  5200                             204  			ADD.B		#1,D0
0000895A  13C0 0000800F                    205  			MOVE.B	D0,CONT_C_C
00008960                                   206  
00008960  1239 00008000                    207  			MOVE.B	N,D1
00008966  B200                             208  IF_C_3			CMP.B		D0,D1
00008968  6600 01C2                        209  			BNE		FINE_C
0000896C                                   210  
0000896C  13FC 0000 0000800F               211  			MOVE.B	#0,CONT_C_C
00008974  13FC 0001 00008012               212  			MOVE.B	#1,FLG_C
0000897C                                   213  
0000897C  1039 00008011                    214  			MOVE.B	FLG_B,D0
00008982  B03C 0001                        215  IF_C_4			CMP.B		#1,D0
00008986  6600 013E                        216  			BNE		ELSE_C_4
0000898A                                   217  
0000898A  1039 00008003                    218  			MOVE.B	CONT_K,D0
00008990  5200                             219  			ADD.B		#1,D0
00008992  13C0 00008003                    220  			MOVE.B	D0,CONT_K
00008998                                   221  			
00008998  1239 00008002                    222  			MOVE.B	K,D1
0000899E  B200                             223  IF_C_5			CMP.B		D0,D1
000089A0  6600 0130                        224  			BNE		ELSE_C_5
000089A4                                   225  
000089A4  11FC 0000 2005                   226  			MOVE.B	#0,PIABC_C
000089AA  11FC 0000 2009                   227  			MOVE.B	#0,PIABC_B
000089B0                                   228  
000089B0  6000 017A                        229  			BRA		FINE_C
000089B4                                   230  
000089B4  13FC 0001 00008016               231  ELSE_C_2		MOVE.B	#1,SOS_C
000089BC  13FC 0000 00008013               232  			MOVE.B	#0,LOCK
000089C4                                   233  			
000089C4  1039 00008015                    234  RIS_B_TOTALE		MOVE.B	SOS_B,D0
000089CA  B03C 0001                        235  			CMP.B		#1,D0
000089CE  6600 015C                        236  			BNE		FINE_C
000089D2                                   237  
000089D2  13FC 0001 00008014               238  			MOVE.B	#1,POS
000089DA  13FC 0000 00008015               239  			MOVE.B	#0,SOS_B
000089E2  1039 0000800E                    240  			MOVE.B	CONT_C_B,D0
000089E8                                   241  			
000089E8  1239 0000800E                    242  			MOVE.B	CONT_C_B,D1
000089EE  5201                             243  			ADD.B		#1,D1
000089F0  13C1 0000800E                    244  			MOVE.B	D1,CONT_C_B
000089F6                                   245  
000089F6  1439 00008000                    246  			MOVE.B	N,D2
000089FC  B401                             247  IF_C_6			CMP.B		D1,D2
000089FE  6600 00B2                        248  			BNE		ELSE_C_6
00008A02                                   249  
00008A02  13FC 0000 0000800E               250  			MOVE.B	#0,CONT_C_B
00008A0A  1439 00008010                    251  			MOVE.B	CONT_M_B,D2
00008A10  5202                             252  			ADD.B		#1,D2
00008A12  13C2 00008010                    253  			MOVE.B	D2,CONT_M_B
00008A18                                   254  
00008A18  1239 00008001                    255  			MOVE.B	M_B,D1
00008A1E  B401                             256  IF_C_7			CMP.B		D1,D2
00008A20  6600 0072                        257  			BNE		ELSE_C_8
00008A24                                   258  
00008A24  13FC 0001 00008011               259  			MOVE.B	#1,FLG_B
00008A2C  13FC 0000 00008010               260  			MOVE.B	#0,CONT_M_B
00008A34  13FC 0000 00008014               261  			MOVE.B	#0,POS
00008A3C                                   262  
00008A3C  1239 00008012                    263  			MOVE.B	FLG_C,D1
00008A42  B23C 0001                        264  IF_C_8			CMP.B		#1,D1
00008A46  6600 004C                        265  			BNE		ELSE_C_8
00008A4A                                   266  			
00008A4A  1239 00008003                    267  			MOVE.B	CONT_K,D1
00008A50  5201                             268  			ADD.B		#1,D1
00008A52  13C1 00008003                    269  			MOVE.B	D1,CONT_K
00008A58                                   270  
00008A58  1439 00008002                    271  			MOVE.B	K,D2
00008A5E  B401                             272  IF_C_9			CMP.B		D1,D2
00008A60  6600 0022                        273  			BNE		ELSE_C_9
00008A64                                   274  			
00008A64  207C 00002008                    275  			MOVEA.L	#PIABD_B,A0
00008A6A  227C 00008004                    276  			MOVEA.L	#MSG_B,A1
00008A70  1390 0000                        277  			MOVE.B	(A0),(A1,D0)
00008A74                                   278  
00008A74  11FC 0000 2005                   279  			MOVE.B	#0,PIABC_C
00008A7A  11FC 0000 2009                   280  			MOVE.B	#0,PIABC_B
00008A80                                   281  			
00008A80  6000 00AA                        282  			BRA		FINE_C
00008A84                                   283  
00008A84  13FC 0000 00008011               284  ELSE_C_9		MOVE.B	#0,FLG_B
00008A8C  13FC 0000 00008012               285  			MOVE.B	#0,FLG_C
00008A94  13FC 0002 00008014               286  ELSE_C_8		MOVE.B	#2,POS
00008A9C                                   287  			
00008A9C  207C 00002008                    288  			MOVEA.L	#PIABD_B,A0
00008AA2  227C 00008004                    289  			MOVEA.L	#MSG_B,A1
00008AA8  1390 0000                        290  			MOVE.B	(A0),(A1,D0)
00008AAC                                   291  			
00008AAC  4EF9 00008942                    292  			JMP		RX_C
00008AB2                                   293  
00008AB2                                   294  ELSE_C_6
00008AB2                                   295  
00008AB2  207C 00002008                    296  			MOVEA.L	#PIABD_B,A0
00008AB8  227C 00008004                    297  			MOVEA.L	#MSG_B,A1
00008ABE  1390 0000                        298  			MOVE.B	(A0),(A1,D0)
00008AC2                                   299  
00008AC2  6000 0068                        300  			BRA		FINE_C
00008AC6                                   301  
00008AC6  13FC 0000 00008014               302  ELSE_C_4		MOVE.B	#0,POS
00008ACE  6000 001A                        303  			BRA		RIS_B
00008AD2                                   304  
00008AD2                                   305  
00008AD2  13FC 0000 00008012               306  ELSE_C_5		MOVE.B	#0,FLG_C
00008ADA  13FC 0000 00008011               307  			MOVE.B	#0,FLG_B
00008AE2  13FC 0000 00008014               308  			MOVE.B	#0,POS
00008AEA                                   309  
00008AEA  1039 00008015                    310  RIS_B			MOVE.B	SOS_B,D0
00008AF0  B03C 0001                        311  			CMP.B		#1,D0
00008AF4  6600 0036                        312  			BNE		FINE_C
00008AF8                                   313  
00008AF8  13FC 0001 00008014               314  			MOVE.B	#1,POS
00008B00  13FC 0000 00008015               315  			MOVE.B	#0,SOS_B
00008B08  1039 0000800E                    316  			MOVE.B	CONT_C_B,D0
00008B0E                                   317  			
00008B0E  1239 0000800E                    318  			MOVE.B	CONT_C_B,D1
00008B14  5201                             319  			ADD.B		#1,D1
00008B16  13C1 0000800E                    320  			MOVE.B	D1,CONT_C_B
00008B1C                                   321  
00008B1C  207C 00002008                    322  			MOVEA.L	#PIABD_B,A0
00008B22  227C 00008004                    323  			MOVEA.L	#MSG_B,A1
00008B28  1390 0000                        324  			MOVE.B	(A0),(A1,D0)
00008B2C                                   325  
00008B2C  4CDF 0307                        326  FINE_C		MOVEM.L	(A7)+,A1-A0/D2-D0
00008B30  4E73                             327  			RTE	
00008B32                                   328  	
00008B32                                   329  			    
00008B32                                   330  
00008B32                                   331  			END		MAIN

No errors detected
No warnings generated
